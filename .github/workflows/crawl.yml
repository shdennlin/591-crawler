name: 591 Rental Crawler

# ┌─────────────────────────────────────────────────────────────────┐
# │  SCHEDULE CONFIGURATION                                         │
# │                                                                 │
# │  To change schedule times:                                      │
# │  1. Edit the desired times below (in your local timezone)       │
# │  2. Convert to UTC: subtract 8 hours for UTC+8 (Taiwan)         │
# │  3. Update the cron expressions                                 │
# │                                                                 │
# │  Current: 06:00, 12:00, 16:00, 22:00 (UTC+8 Taiwan)             │
# │  Cron format: 'minute hour * * *' (runs daily)                  │
# └─────────────────────────────────────────────────────────────────┘
on:
  schedule:
    # Local Time (UTC+8)  →  UTC Time  →  Cron
    # ─────────────────────────────────────────
    - cron: '0 22 * * *'   # 06:00 UTC+8 → 22:00 UTC
    - cron: '0 4 * * *'    # 12:00 UTC+8 → 04:00 UTC
    - cron: '0 8 * * *'    # 16:00 UTC+8 → 08:00 UTC
    - cron: '0 14 * * *'   # 22:00 UTC+8 → 14:00 UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright Chromium
        run: npx playwright install chromium

      # ─────────────────────────────────────────────────────────────────
      # MULTIPLE SHEETS SUPPORT
      # ─────────────────────────────────────────────────────────────────
      # To add more sheets, simply add secrets with GOOGLE_SHEETS_ID_<NAME> pattern:
      #   - GOOGLE_SHEETS_ID (default)
      #   - GOOGLE_SHEETS_ID_WORK
      #   - GOOGLE_SHEETS_ID_PERSONAL
      # No workflow file changes needed - secrets are auto-discovered!
      # ─────────────────────────────────────────────────────────────────

      - name: Load Google Sheets configuration
        run: |
          # Auto-discover all GOOGLE_SHEETS_ID* secrets and export as env vars
          echo '${{ toJson(secrets) }}' | jq -r '
            to_entries
            | .[]
            | select(.key | startswith("GOOGLE_SHEETS_ID"))
            | "\(.key)<<EOF\n\(.value)\nEOF"
          ' >> $GITHUB_ENV
        shell: bash

      - name: Run crawler
        env:
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        run: npx tsx crawler.ts
